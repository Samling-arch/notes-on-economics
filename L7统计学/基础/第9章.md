
# 1 第九章：分类数据分析

## 1.1 一、基本概念

### 1.1.1 分类数据与频数
- **变量分类** (第一章内容回顾):
    - 分类变量
    - 顺序变量
    - 数值型变量
- **分类数据**: 分类变量的取值。
    - *例子*: 性别（男、女）是分类变量，其数据“男”和“女”就是分类数据。
- **频数 (Frequency)**: 对分类数据进行汇总的结果。
    - *例子*: 统计后得到“有多少个男的，有多少个女的”，这个结果就是频数。
> [!NOTE] 本章核心
    > > 我们关注的焦点就是对**频数**进行分析。

### 1.1.2 卡方检验 (Chi-square Test)
- **定义**: 一种对**分类数据**的**频数**进行分析的统计方法。
- **核心目的**: 比较实际观测到的频数与理论期望的频数是否存在显著差异。

## 1.2 二、拟合优度检验 (Goodness-of-Fit Test)

### 1.2.1 卡方统计量 ($χ²$)
- **计算公式**:
  $$
  χ² = \sum \frac{(f_₀ - f_ₑ)²}{f_ₑ}
  $$
  - `$f₀$` (f-observed): **实际频数** (Actual Frequency)
  - `$fₑ$` (f-expected): **期望频数** (Expected Frequency)

- **核心逻辑**:
    - `$f₀$` 和 `$fₑ$` 相差**越小** → `$χ²$` 值**越小** (拟合得好)。
    - `$f₀$` 和 `$fₑ$` 相差**越大** → `$χ²$` 值**越大** (拟合得差)。

- > [!IMPORTANT] 卡方检验是单侧检验
> 备择假设成立时（即实际与期望不符），差值的平方会使 `$χ²$` **单方面地变大**。因此，卡方检验是**右侧单边检验**。

### 1.2.2 应用实例

#### 1.2.2.1 实例一：泰坦尼克号生存状况 (两个类别)

> [!WARNING] UP主指出的问题
> 原题问“存活状况是否和性别有关”涉及两个变量（性别、存活状况），严格来说应属于**列联表的独立性检验**。此处为了演示拟合优度检验，将问题修改为：**男女存活者的比例，是否是按照船上男女总人数的比例来分配的？**

- **数据**:
    - 总人数: `$2208$`人 (男: `$1731$`, 女: `$470$`)  *(注：UP主口误为1738，但计算一致)*
    - 幸存者: `$711$`人 (男: `$367$`, 女: `$344$`) *(注：UP主口误数据有多个版本，此处按其核心逻辑整理)*
    - *核心问题*: 幸存者中，男性比例是否应为 `$1731 / 2208$`？

- **与Z检验的等价性**:
    - 这个问题本质上是**单总体比例检验**，可以用第八章的 **Z检验** 来做。
    - 原假设 `$H₀: π = 1731/2208$`
    - 备择假设 `$H₁: π ≠ 1731/2208$`
    - 这是一个双侧Z检验，例如在 `$\alpha=0.1$` 时，拒绝域为 `$|Z| \geq 1.645$`。

- **卡方检验步骤**:
    1. **实际频数 `$f₀$`**:
        - `$f₀(\text{男幸存}) = 367$`
        - `$f₀(\text{女幸存}) = 344$`
    2. **计算期望频数 `$fₑ$`**:
        - `$fₑ(\text{男幸存})` = 总幸存人数 × 理论男性比例 = `$711 \times (1731 / 2208) \approx 556.5$` *(注：UP主口误数据计算为565)*
        - `$fₑ(\text{女幸存})` = 总幸存人数 × 理论女性比例 = `$711 \times (470 / 2208) \approx 151.5$`
    3. **计算卡方统计量 `$χ²$`**:
        - 将`$f₀$`和`$fₑ$`代入公式求和，UP主计算结果为 `$χ² \approx 300$`。
    4. **自由度 `$df$`**:
        - `$df = k - 1$` (`$k$`为类别数)
        - `$df = 2 - 1 = 1$`
    5. **决策**:
        - 查表得临界值 `$χ²_{0.05}(1) = 3.841$` *(注：UP主口误为2.706)*。
        - `$300 \gg 3.841$`，因此**拒绝原假设**，认为男女幸存比例与总人数比例不符。

- > [!TIP] Z检验与卡方检验的等价关系
> - 当自由度为`$1$`时，卡方分布是标准正态分布的平方，即 **`$χ²(1) = Z²$`**。
> - `$Z$` 服从 `$N(0, 1)$`，`$Z²$` 服从 `$χ²(1)$`。
> - 两种方法在只有两个类别时是**完全等价**的，`$|Z|$` 越大，`$Z²$` (即`$χ²$`)也越大，结论完全相同。

#### 1.2.2.2 实例二：孟德尔豌豆杂交实验 (多个类别)

> UP主趣谈：“唤醒了多年沉睡的记忆，生物的DNA动了。”

- **背景**:
    - 理论比例: 黄色圆粒 : 绿色圆粒 : 黄色皱粒 : 绿色皱粒 = **`$9:3:3:1$`**
    - 样本: 共收获 `$556$` 颗豌豆。
    - 实际频数 `$f₀$`: `$315$`, `$108$`, `$101$`, `$32$`
- **检验步骤**:
    1. **计算期望频数 `$fₑ$`**:
        - `$fₑ(\text{黄圆}) = 556 \times (9/16) = 312.75$`
        - `$fₑ(\text{绿圆}) = 556 \times (3/16) = 104.25$`
        - `$fₑ(\text{黄皱}) = 556 \times (3/16) = 104.25$`
        - `$fₑ(\text{绿皱}) = 556 \times (1/16) = 34.75$`
    2. **计算卡方统计量 `$χ²$`**:
        - 将四组`$f₀$`和`$fₑ$`代入公式求和，得到 `$χ² = 0.47$`。
    3. **自由度 `$df$`**:
        - `$df = k - 1 = 4 - 1 = 3$`
    4. **决策**:
        - 查表得临界值 `$χ²_{0.05}(3) = 7.815$`。
        - `$0.47 < 7.815$`，因此**接受原假设**，认为观测数据与孟德尔的理论比例吻合。

- > [!IMPORTANT] 多类别问题无法使用Z检验
> - Z检验本质是检验**一个**比例，只适用于两个类别的情况（知道A的比例，B的比例也随之确定）。
> - 对于三个及以上类别的拟合优度问题，**只能使用卡方检验**。

## 1.3 三、列联分析与独立性检验 (Test of Independence)

### 1.3.1 基本概念
- **列联表 (Contingency Table)**: 将两个或多个分类变量进行交叉分类的频数分布表。
- **独立性检验**: 检验列联表中的**行变量**和**列变量**是否**相互独立**。

### 1.3.2 期望频数 `$fₑ$` 的计算
- **逻辑**: 如果两变量独立，则 `$P(A \text{ and } B) = P(A) \times P(B)$`。
- **公式**:
  $$
  f_ₑ = \frac{(\text{行合计}) \times (\text{列合计})}{\text{总计}}
  $$
  - *例子*: `$fₑ(\text{甲地区, 一级}) = (140 \times 162) / 500 = 45.36$`

### 1.3.3 自由度 `$df$` 的计算
- **公式**: `$df = (r - 1) \times (c - 1)$`
    - `$r$`: 行数
    - `$c$`: 列数

- **两种理解方式**:
    1. **直观理解 (填格子法)**:
        - 在行合计和列合计都固定的情况下，你只需要自由地填满 `$(r-1) \times (c-1)$` 个单元格，剩下的单元格为了满足总计约束，其数值就都确定了。自由变量的个数就是自由度。
    2. **数学推导 (约束法)**:
        - UP主趣解：“敌人的敌人就是朋友”。
        - 总变量数: `$r \times c$`
        - 减去行约束: `$- r$`
        - 减去列约束: `$- c$`
        - 加上一个补偿: `$+ 1$` (因为行合计之和与列合计之和都等于总计，有一个约束是重复的，需要加回来)。
        - 结果: `$rc - r - c + 1 = (r - 1)(c - 1)$`。

## 1.4 四、相关性的测量 (Measures of Association)

### 1.4.1 Phi ($\phi$) 相关系数
- **公式**: 
$$
\phi = \sqrt{\frac{χ²}{n}}
$$
- **适用**: 最常用于 **`$2 \times 2$`** 列联表。
- **取值**: 在 `$2 \times 2$` 表中，取值在 `$0$` (独立) 到 `$1$` (完全相关) 之间。
- > [!WARNING] UP主指出的公式问题
> - 对于 `$2 \times 2$` 表，简化公式为 `$(ad-bc) / \sqrt{...}$`。
> - UP主强调：既然是开算术平方根，结果不应为负。分子 `$ad-bc$` 应该**加绝对值**。
> - **理由**: 如果将两列互换位置，`$b$`和`$c$`不变，`$a$`和`$d$`互换，表的意义不变，但 `$ad-bc$` 会变号。这说明**符号没有实际意义**。
- **缺点**: 当行或列数大于`$2$`时，`$\phi$` 系数的值可能会超过`$1$`，没有上限，无法判断相关程度。

### 1.4.2 列联 (C) 相关系数
- **目的**: 对 `$\phi$` 系数进行修正，使其值不会超过`$1$`。
- **缺点**: 其最大值依赖于行数和列数，**无法达到`$1$`**。因此，不同大小的列联表之间的 `$C$` 系数**不具有可比性**。

### 1.4.3 V 相关系数 (Cramér's V)
- **目的**: 对 `$\phi$` 系数的推广和优化，是目前最常用的方法。
- **优点**:
    - **取值范围固定**: 永远在 **`$0$` 到 `$1$`** 之间。
    - `$V = 0$`: 变量相互独立。
    - `$V = 1$`: 变量完全相关。
    - **可比性强**: 不同大小的列联表计算出的 `$V$` 系数可以相互比较。

## 1.5 五、卡方检验的注意事项

### 1.5.1 因果关系与行列设置
- **原则**: 如果变量间存在因果关系，一般将**原因变量**放在**行 (row)**，**结果变量**放在**列 (column)**。
- *例子*: `原因(从事行业)` vs `结果(价值取向)`
    - 制造/服务业 (原因) -> 放在行
    - 物质/人际关系 (结果) -> 放在列

### 1.5.2 样本代表性问题
- **场景**: 当样本的内部结构是**人为控制**的，不能代表总体的真实分布时，直接分析会产生误导。
- *例子 (青少年犯罪)*:
    - 人为抽取`$100$`个未犯罪和`$75$`个犯罪少年，这个`$75:100$`的比例**严重偏离**了总体中犯罪率极低的事实。
    - **错误结论**: 直接计算会得出“完整家庭中犯罪率也很高”的假象。
    - > [!CAUTION] UP主指出的解读修正
    > > 此时应反向解读百分比，正确的说法是“在**未犯罪**的青少年中，来自完整家庭的占`$92\%$`”，而不是“在完整家庭中，未犯罪的占xx%”。这两个地方要换个位置。

### 1.5.3 期望频数的要求
- **原因**: `$fₑ$` 是公式中的**分母**。如果 `$fₑ$` 太小，一个微小的随机波动都可能导致 `$χ²$` 值被**不成比例地放大**，使结果失真。
- **准则**:
    - **`$2 \times 2$` 表**: 要求所有单元格的期望频数 `$fₑ \geq 5$`。
    - **`$> 2 \times 2$` 表**: 期望频数 `$fₑ < 5$` 的单元格数量不能超过总单元格数的 **`$20\%$`**。
- **解决方法**:
    - 将 `$fₑ$` 过小的类别与相近的类别进行**合并**，以增大合并后的期望频数。

---

## 1.6 总结表格

| 检验类型/概念             | 核心目的                        | 自由度 (df)               | 关键公式/计算                                                     | 适用场景/注意事项                                                         |
| :------------------ | :-------------------------- | :--------------------- | :---------------------------------------------------------- | :---------------------------------------------------------------- |
| **拟合优度检验**          | 检验一组观测频数是否符合某个理论（或期望）的分布比例。 | `$k - 1$`              | `$$χ² = \sum\frac{(f₀-fₑ)²}{fₑ}$$`                          | - 适用于单个分类变量。<br>- `$k=2$` 时与Z检验等价。<br>- `$k>2$` 时只能用卡方。           |
| **独立性检验**           | 检验两个分类变量是否相互独立。             | `$(r-1) \times (c-1)$` | `$$fₑ = \frac{(\text{行合计})\times(\text{列合计})}{\text{总计}}$$` | - 适用于两个分类变量构成的列联表。<br>- 原因变量放行，结果变量放列。                            |
| **Phi ($\phi$) 系数** | 测量两个分类变量间的相关程度。             | -                      | `$$\phi = \sqrt{\frac{χ²}{n}}$$`                            | - 最适用于`$2×2$`表。<br>- `$>2×2$`表时值可能超过`$1$`，失去意义。                   |
| **列联 (C) 系数**       | `$\phi$`系数的修正，保证值不超过`$1$`。  | -                      | `$$C = \sqrt{\frac{χ²}{χ²+n}}$$`                            | - 值无法达到`$1$`，不同大小的表不可比。                                           |
| **V 系数**            | `$\phi$`系数的优化，最常用的相关测量。     | -                      | `$$V = \sqrt{\frac{χ²}{n\times\min(r-1,c-1)}}$$`            | - **推荐使用**。<br>- 值域为`$[0,1]$`，不同表之间可比。                            |
| **卡方检验前提**          | 保证检验的有效性，防止结果失真。            | -                      | -                                                           | - **期望频数**不能过小（`$fₑ\geq5$`或`$fₑ<5$`的单元格`$<20\%$`）。<br>- 样本需能代表总体。 |